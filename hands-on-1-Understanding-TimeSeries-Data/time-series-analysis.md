# การวิเคราะห์อนุกรมเวลาและการกำหนดพารามิเตอร์สำหรับโมเดล ARIMA

## บทนำ

การวิเคราะห์อนุกรมเวลาเป็นเทคนิคสำคัญในการศึกษาข้อมูลที่เปลี่ยนแปลงตามเวลา โดยเฉพาะอย่างยิ่งเมื่อต้องการพยากรณ์ค่าในอนาคต เอกสารนี้รวบรวมการวิเคราะห์กราฟอนุกรมเวลาและวิธีการกำหนดพารามิเตอร์สำหรับโมเดล ARIMA และโมเดลอื่นๆ ที่เกี่ยวข้อง

## 1. องค์ประกอบของอนุกรมเวลา

อนุกรมเวลาประกอบด้วยองค์ประกอบหลัก 4 ประการ:

1. **แนวโน้ม (Trend)** - การเปลี่ยนแปลงในระยะยาว แสดงทิศทางการเคลื่อนไหวของข้อมูลโดยรวม
2. **ฤดูกาล (Seasonality)** - รูปแบบที่เกิดซ้ำในระยะเวลาที่แน่นอนและคาดการณ์ได้
3. **วัฏจักร (Cyclical)** - รูปแบบขึ้นลงในระยะยาว แต่ไม่มีความถี่ที่แน่นอน มักเกี่ยวข้องกับวัฏจักรทางเศรษฐกิจ
4. **ความไม่สม่ำเสมอ (Irregular)** - ความผันผวนแบบสุ่มที่ไม่สามารถอธิบายด้วยองค์ประกอบอื่น

## 2. กรณีศึกษา: ข้อมูลการผลิตไฟฟ้า

### 2.1 ลักษณะของข้อมูล

ข้อมูลที่ใช้ในการวิเคราะห์คือข้อมูลการผลิตไฟฟ้าในช่วงปี 2020-2023 ซึ่งเกิดจากการจำลองด้วยโค้ดที่มีองค์ประกอบดังนี้:

```python
# สร้างชุดข้อมูลจำลอง 
def create_power_production_data(start_date='2020-01-01', end_date='2022-12-31'):
    # สร้างช่วงวันที่
    date_range = pd.date_range(start=start_date, end=end_date, freq='H')
    df = pd.DataFrame(index=date_range)
    
    # 1. แนวโน้ม (Trend) - การเติบโตของความต้องการไฟฟ้า 3% ต่อปี
    days = (df.index - df.index[0]).total_seconds() / (246060)
    daily_growth = (1.03)**(1/365)  # การเติบโต 3% ต่อปี
    trend = 1000 * (daily_growth ** (days))
    
    # 2. ฤดูกาล (Seasonality)
    # ฤดูกาลรายปี - ความต้องการไฟฟ้าเพิ่มขึ้นในฤดูร้อนและฤดูหนาว
    yearly_seasonality = 150 * np.sin(2 * np.pi * days / 365)
    
    # ฤดูกาลรายวัน - สูงในช่วงกลางวัน ต่ำในช่วงกลางคืน
    hour_of_day = df.index.hour
    daily_pattern = 100 * np.sin(np.pi * hour_of_day / 12)
    
    # ฤดูกาลรายสัปดาห์ - ต่ำในวันหยุดสุดสัปดาห์
    day_of_week = df.index.dayofweek
    weekly_pattern = np.where(day_of_week >= 5, -80, 0)  # ลด 80 หน่วยในวันเสาร์-อาทิตย์
    
    # 3. วัฏจักร (Cyclical) - วัฏจักรทางเศรษฐกิจประมาณ 3 ปี
    cycle_period = 3 * 365  # วัฏจักร 3 ปี
    cyclical = 70 * np.sin(2 * np.pi * days / cycle_period)
    
    # 4. Irregular Component - ความผันผวนทั่วไปและเหตุการณ์พิเศษ
    np.random.seed(42)  # ตั้งค่า seed สำหรับการสร้างค่าแบบสุ่ม
    irregular = np.random.normal(0, 30, len(df))
    
    # เพิ่มเหตุการณ์พิเศษบางวัน (เช่น ไฟดับหรือซ่อมบำรุงโรงไฟฟ้า)
    special_events = pd.Series(0, index=df.index)
    
    # สมมติว่ามีการซ่อมบำรุงโรงไฟฟ้าในบางช่วง
    maintenance_periods = [
        ('2021-04-10', '2021-04-15'),
        ('2022-09-05', '2022-09-10')
    ]
    for start, end in maintenance_periods:
        mask = (df.index >= start) & (df.index <= end)
        special_events[mask] = -200  # ลดการผลิตลง 200 หน่วย
    
    # สมมติว่ามีเหตุการณ์ฉุกเฉินทำให้โรงไฟฟ้าหยุดทำงานชั่วคราว
    emergency_dates = ['2021-07-15', '2022-11-30']
    for date in emergency_dates:
        # ส่งผลกระทบ 48 ชั่วโมง
        start_date = pd.Timestamp(date)
        end_date = start_date + pd.Timedelta(hours=48)
        mask = (df.index >= start_date) & (df.index < end_date)
        special_events[mask] = -350  # ลดการผลิตลง 350 หน่วย
    
    # รวมองค์ประกอบทั้งหมด
    df['power_production'] = trend + yearly_seasonality + daily_pattern + weekly_pattern + cyclical + irregular + special_events
    
    # ปรับให้ค่าต่ำสุดไม่น้อยกว่า 100 (กำลังการผลิตขั้นต่ำ)
    df['power_production'] = df['power_production'].clip(lower=100)
    
    # เพิ่มคอลัมน์ข้อมูลเวลาที่ง่ายต่อการวิเคราะห์
    df['hour'] = df.index.hour
    df['day'] = df.index.day
    df['month'] = df.index.month
    df['year'] = df.index.year
    df['day_of_week'] = df.index.dayofweek
    df['weekend'] = df['day_of_week'].apply(lambda x: 1 if x >= 5 else 0)
    
    return df
```

### 2.2 การวิเคราะห์รูปแบบวันทำงานกับวันหยุด

จากกราฟ Box Plot เปรียบเทียบกำลังการผลิตไฟฟ้าระหว่างวันทำงานและวันหยุด พบว่า:

1. **ความแตกต่างของค่าเฉลี่ย**: 
   - วันทำงาน: 1041.91 MW
   - วันหยุด: 964.39 MW
   - ความแตกต่าง: 7.44%

2. **การกระจายตัวของข้อมูล**: 
   - วันทำงานมีค่ามัธยฐานสูงกว่า
   - วันทำงานมีค่าผิดปกติ (outliers) มากกว่า
   - ทั้งสองประเภทวันมีช่วงค่าที่ใกล้เคียงกัน

3. **นัยสำคัญต่อการสร้างโมเดล**:
   - มีรูปแบบฤดูกาลรายสัปดาห์ที่ชัดเจน (s = 7)
   - ควรพิจารณาใช้ตัวแปรหุ่น (dummy variable) "weekend" ในโมเดล SARIMAX
   - อาจพิจารณาสร้างโมเดลแยกสำหรับวันทำงานและวันหยุด

### 2.3 การวิเคราะห์องค์ประกอบแนวโน้มและฤดูกาล

จากการแยกองค์ประกอบของอนุกรมเวลา สามารถวิเคราะห์ได้ดังนี้:

1. **ข้อมูลการผลิตไฟฟ้ารายวัน (Daily Power Production Data)**:
   - มีรูปแบบขึ้นลงที่ชัดเจนในหลายระดับความถี่
   - มีจุดผิดปกติที่เห็นเป็นการลดลงอย่างฉับพลันในบางช่วงเวลา

2. **องค์ประกอบแนวโน้ม (Trend Component)**:
   - มีการเปลี่ยนแปลงทิศทางในระยะยาว (ไม่เป็นเชิงเส้นตรง)
   - เพิ่มขึ้นในช่วงต้นปี 2020 ถึงปลายปี 2020
   - ลดลงต่อเนื่องจากต้นปี 2021 ถึงต้นปี 2022
   - เริ่มฟื้นตัวอีกครั้งหลังจากกลางปี 2022

3. **องค์ประกอบฤดูกาล (Seasonal Component)**:
   - มีรูปแบบฤดูกาลรายปีที่ชัดเจน
   - ค่าสูงในช่วงต้นถึงกลางปี (มีนาคม-พฤษภาคม)
   - ค่าต่ำในช่วงปลายปี (กันยายน-พฤศจิกายน)
   - มีความแกว่งขนาดเล็กภายในแต่ละรอบใหญ่ (รูปแบบรายสัปดาห์)

4. **องค์ประกอบความไม่สม่ำเสมอ (Residual/Irregular Component)**:
   - ยังคงมีรูปแบบการแกว่งตัวที่เป็นจังหวะอยู่
   - มีค่าผิดปกติที่เด่นชัดในหลายช่วงเวลา
   - ความผันผวนมีระดับที่ไม่คงที่ตลอดช่วงเวลา
   - การกระจายตัวไม่เป็นแบบปกติ

## 3. การกำหนดพารามิเตอร์สำหรับโมเดล ARIMA

โมเดล ARIMA(p,d,q)(P,D,Q)s มีพารามิเตอร์ที่ต้องกำหนดดังนี้:

- **p**: จำนวนค่า AR terms
- **d**: ระดับของ regular differencing
- **q**: จำนวนค่า MA terms
- **P**: จำนวนค่า seasonal AR terms
- **D**: ระดับของ seasonal differencing
- **Q**: จำนวนค่า seasonal MA terms
- **s**: ความยาวของฤดูกาล

### 3.1 การกำหนดค่า d (Regular Differencing)

จากการวิเคราะห์แนวโน้ม:
- ข้อมูลมีแนวโน้มที่ไม่เป็นเชิงเส้นตรง และมีการเปลี่ยนแปลงทิศทางในระยะยาว
- ควรใช้ d = 1 เนื่องจากข้อมูลมีแนวโน้มที่ไม่คงที่
- อย่างไรก็ตาม เนื่องจากแนวโน้มไม่เป็นเชิงเส้นตรง โมเดล ARIMA อาจไม่เหมาะสมที่สุด

### 3.2 การกำหนดค่า s (Seasonal Period)

จากการวิเคราะห์รูปแบบฤดูกาล:
- สำหรับการจับรูปแบบรายสัปดาห์: s = 7 (สำหรับข้อมูลรายวัน)
- สำหรับการจับรูปแบบรายปี: s = 365 (สำหรับข้อมูลรายวัน)
- สำหรับข้อมูลรายชั่วโมง: อาจใช้ s = 24 (รายวัน) หรือ s = 168 (24×7, รายสัปดาห์)

### 3.3 การกำหนดค่า D (Seasonal Differencing)

- ควรใช้ D = 1 เนื่องจากมีการเปลี่ยนแปลงในความสูงของรูปแบบฤดูกาลตามเวลา

### 3.4 การกำหนดค่า p, q, P, Q

- ต้องวิเคราะห์จากกราฟ ACF และ PACF หลังจากทำ differencing แล้ว
- เนื่องจากในตัวอย่างนี้ไม่มีกราฟ ACF และ PACF จึงไม่สามารถระบุค่าที่เหมาะสมได้

## 4. ข้อจำกัดของโมเดล ARIMA สำหรับข้อมูลนี้

จากการวิเคราะห์พบว่าโมเดล ARIMA มีข้อจำกัดสำหรับข้อมูลการผลิตไฟฟ้านี้:

1. **แนวโน้มไม่เป็นเชิงเส้น**: ARIMA ดั้งเดิมทำงานได้ดีกับแนวโน้มเชิงเส้น แต่แนวโน้มในข้อมูลนี้มีการเปลี่ยนแปลงทิศทาง

2. **ฤดูกาลหลายระดับ**: ข้อมูลมีรูปแบบฤดูกาลทั้งรายวัน รายสัปดาห์ และรายปี ซึ่ง SARIMA แบบมาตรฐานจัดการได้ยาก

3. **ค่าผิดปกติหลายจุด**: มีค่าผิดปกติที่เกิดจากเหตุการณ์พิเศษ ซึ่งอาจส่งผลต่อประสิทธิภาพของโมเดล ARIMA

4. **ความผันผวนไม่คงที่**: ความผันผวนของข้อมูลมีระดับที่เปลี่ยนแปลงตามเวลา

## 5. โมเดลทางเลือกที่เหมาะสมกว่า

สำหรับข้อมูลการผลิตไฟฟ้านี้ โมเดลทางเลือกที่อาจเหมาะสมกว่า ARIMA ได้แก่:

### 5.1 โมเดลที่จับแนวโน้มไม่เชิงเส้นได้

- **Prophet (Facebook)**: รองรับแนวโน้มที่ไม่เป็นเชิงเส้น ฤดูกาลหลายระดับ และค่าผิดปกติ
- **TBATS**: สามารถจับรูปแบบฤดูกาลหลายระดับและแนวโน้มที่ซับซ้อนได้
- **STL decomposition + ARIMA**: แยกองค์ประกอบแล้วใช้ ARIMA กับส่วนที่เหมาะสม

### 5.2 โมเดลไม่เชิงเส้น

- **Neural Networks (LSTM, TCN)**: เหมาะสำหรับรูปแบบที่ซับซ้อนและไม่เชิงเส้น
- **NeuralProphet**: ผสมคุณสมบัติของ Prophet กับเครือข่ายประสาทเทียม

### 5.3 โมเดลผสม

- **SARIMA + Neural Networks**: ผสมเพื่อจับรูปแบบทั้งเชิงเส้นและไม่เชิงเส้น
- **SARIMAX + ตัวแปรภายนอก**: เพิ่มตัวแปรหุ่นสำหรับวันหยุด และเหตุการณ์พิเศษ

### 5.4 โมเดลที่จัดการความผันผวนไม่คงที่

- **GARCH**: จัดการกับความแปรปรวนที่เปลี่ยนแปลงตามเวลา
- **Robust Time Series Models**: ทนทานต่อค่าผิดปกติ

## 6. แนวทางการสร้างโมเดลที่เหมาะสม

### 6.1 ขั้นตอนการวิเคราะห์และสร้างโมเดล

1. **วิเคราะห์ข้อมูลเชิงสำรวจ**:
   - ดูกราฟในหลายมาตราส่วนเวลา
   - วิเคราะห์องค์ประกอบของอนุกรมเวลา
   - ตรวจสอบค่าผิดปกติและเหตุการณ์พิเศษ

2. **เตรียมข้อมูล**:
   - จัดการค่าสูญหาย (ถ้ามี)
   - ระบุและจัดการค่าผิดปกติ
   - แปลงข้อมูลตามความเหมาะสม (เช่น log transformation)

3. **เลือกโมเดลที่เหมาะสม**:
   - พิจารณาความซับซ้อนของข้อมูล
   - เลือกระหว่าง ARIMA/SARIMA หรือโมเดลทางเลือก
   - เตรียมตัวแปรภายนอกที่เกี่ยวข้อง (ถ้าใช้ SARIMAX)

4. **ทดสอบและประเมินโมเดล**:
   - ใช้เทคนิค time series cross-validation
   - ประเมินด้วยเกณฑ์ที่เหมาะสม (MAE, RMSE, MAPE)
   - ตรวจสอบค่าคงเหลือ (residuals) ว่าเป็น white noise หรือไม่

### 6.2 การจัดการกับฤดูกาลหลายระดับ

1. **ใช้โมเดลที่รองรับฤดูกาลหลายระดับโดยตรง**:
   - TBATS, Prophet, NeuralProphet
   
2. **แยกองค์ประกอบและสร้างโมเดลย่อย**:
   - ใช้ STL decomposition แยกองค์ประกอบฤดูกาลที่ต่างระดับกัน
   - สร้างโมเดลแยกสำหรับแต่ละองค์ประกอบ

3. **ใช้ตัวแปรภายนอกเพื่อจับรูปแบบฤดูกาล**:
   - สร้างตัวแปรหุ่นสำหรับวันในสัปดาห์, เดือน, ฤดูกาล, วันหยุดพิเศษ
   - ใช้ SARIMAX หรือโมเดลที่รองรับตัวแปรภายนอก

### 6.3 การจัดการกับแนวโน้มที่ไม่เป็นเชิงเส้น

1. **ใช้โมเดลที่รองรับแนวโน้มไม่เชิงเส้น**:
   - Prophet, TBATS, State Space Models
   
2. **แบ่งข้อมูลตามจุดเปลี่ยนทิศทางแนวโน้ม**:
   - สร้างโมเดลแยกสำหรับแต่ละช่วง
   - ใช้เทคนิค change point detection

3. **ใช้โมเดลไม่เชิงเส้น**:
   - Neural Networks, Gradient Boosting Models
   - โมเดลผสมที่รวมทั้ง ARIMA และโมเดลไม่เชิงเส้น

## 7. บทสรุป

การวิเคราะห์ข้อมูลการผลิตไฟฟ้าแสดงให้เห็นว่า:

1. ข้อมูลมีความซับซ้อนสูง ประกอบด้วยแนวโน้มที่ไม่เป็นเชิงเส้น ฤดูกาลหลายระดับ และค่าผิดปกติจากเหตุการณ์พิเศษ

2. โมเดล ARIMA/SARIMA แบบดั้งเดิมอาจไม่เหมาะสมที่สุดสำหรับข้อมูลนี้ เนื่องจากข้อจำกัดในการจับแนวโน้มที่ไม่เป็นเชิงเส้นและฤดูกาลหลายระดับ

3. โมเดลทางเลือกที่มีความยืดหยุ่นมากกว่า เช่น Prophet, TBATS, หรือโมเดลผสม น่าจะให้ผลลัพธ์ที่ดีกว่า

4. การวิเคราะห์กราฟและการแยกองค์ประกอบของอนุกรมเวลามีความสำคัญอย่างยิ่งในการทำความเข้าใจข้อมูลและเลือกโมเดลที่เหมาะสม

การเลือกโมเดลที่เหมาะสมสำหรับข้อมูลอนุกรมเวลาขึ้นอยู่กับลักษณะเฉพาะของข้อมูล ไม่มีโมเดลหนึ่งที่เหมาะสมที่สุดสำหรับทุกกรณี การวิเคราะห์ข้อมูลอย่างละเอียดและการเข้าใจข้อจำกัดของแต่ละโมเดลจะช่วยให้สามารถเลือกวิธีการที่เหมาะสมที่สุดสำหรับข้อมูลเฉพาะนั้นๆ